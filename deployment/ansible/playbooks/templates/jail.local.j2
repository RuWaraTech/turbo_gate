[DEFAULT]
# Ban IP for this duration (in seconds)
bantime = {{ fail2ban_bantime | default(3600) }}

# Time window to count failures
findtime = {{ fail2ban_findtime | default(600) }}

# Number of failures before ban
maxretry = {{ fail2ban_maxretry | default(5) }}

# IPs to never ban (internal networks)
ignoreip = 127.0.0.1/8 10.0.0.0/16 ::1

# Backend for log monitoring
backend = systemd

# Log settings
loglevel = INFO
logtarget = /var/log/fail2ban.log

# Ban action
banaction = iptables-multiport
banaction_allports = iptables-allports

#
# JAILS
#

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = {{ ssh_maxretry | default(3) }}
bantime = {{ fail2ban_bantime | default(3600) }}

[sshd-ddos]
enabled = true
port = ssh
filter = sshd-ddos
logpath = /var/log/auth.log
maxretry = 2
bantime = 86400

{% if 'swarm_managers' in group_names %}
# nginx jails (only for manager nodes)
[nginx-http-auth]
enabled = true
filter = nginx-http-auth
port = http,https
logpath = /var/log/turbogate/nginx/*access.log
maxretry = 5
bantime = 3600

[nginx-limit-req]
enabled = true
filter = nginx-limit-req
port = http,https
logpath = /var/log/turbogate/nginx/*error.log
maxretry = 10
bantime = 1800

[nginx-404]
enabled = true
port = http,https
filter = nginx-404
logpath = /var/log/turbogate/nginx/*access.log
bantime = 3600
maxretry = 20
findtime = 600
{% endif %}

# Port scanning protection (all nodes)
[portscan]
enabled = true
filter = portscan
logpath = /var/log/syslog
maxretry = 6
bantime = 86400