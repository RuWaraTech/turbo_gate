# ModSecurity core configuration
SecRuleEngine {{ modsecurity_rule_engine | default('On') }}
SecAuditEngine RelevantOnly
SecAuditLog /var/log/nginx/modsec_audit.log
SecAuditLogType Serial
SecAuditLogStorageDir /var/log/nginx/
SecAuditLogParts ABCEFHZ
SecDebugLog /var/log/nginx/modsec_debug.log
SecDebugLogLevel {{ modsecurity_debug_level | default(0) }}

# Request body handling
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyInMemoryLimit 131072
SecRequestBodyLimitAction Reject

# Response body handling
SecResponseBodyLimit 1048576
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimitAction ProcessPartial

# File uploads
SecUploadDir /tmp
SecUploadKeepFiles Off
SecTmpDir /tmp
SecDataDir /tmp

# XML processing
SecDefaultAction "phase:1,log,auditlog,pass"
SecDefaultAction "phase:2,log,auditlog,pass"

# Unicode mapping
SecUnicodeMapFile unicode.mapping 20127

# Include OWASP Core Rule Set
{% if modsecurity_crs_enabled | default(true) %}
Include /etc/modsecurity/crs-setup.conf
Include /etc/modsecurity/rules/*.conf
{% endif %}

# Custom rules directory
Include /etc/modsecurity/custom_rules/*.conf