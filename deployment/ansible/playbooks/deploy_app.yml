---
- name: Deploy TurboGate Application
  hosts: swarm_managers
  become: yes
  
  vars:
    stack_name: turbogate
    compose_file: /opt/turbogate/docker-compose.yml
    health_check_timeout: 60

  tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - secret_key is defined
          - redis_password is defined
          - domain_name is defined
        fail_msg: "Required variables (secret_key, redis_password, domain_name) must be defined"

    - name: Create application directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop:
        - /opt/turbogate
        - /var/log/turbogate
        - /var/lib/turbogate/redis
        - /var/log/turbogate/nginx

    - name: Check if Docker secrets already exist
      ansible.builtin.command: docker secret ls --format '{{ '{{' }}.Name{{ '}}' }}'
      register: existing_secrets
      changed_when: false

    - name: Remove existing secrets if they exist
      ansible.builtin.command: docker secret rm {{ item.name }}
      loop:
        - { name: "turbogate_secret_key" }
        - { name: "redis_password" }
      when: item.name in existing_secrets.stdout_lines
      ignore_errors: true

    - name: Create Docker secrets
      community.docker.docker_secret:
        name: "{{ item.name }}"
        data: "{{ item.value | b64encode }}"
        state: present
      loop:
        - { name: "turbogate_secret_key", value: "{{ secret_key }}" }
        - { name: "redis_password", value: "{{ redis_password }}" }
      when: item.value is defined and item.value | length > 0
      no_log: true
    
    - name: Verify overlay network exists
      community.docker.docker_network:
        name: turbogate_network
        driver: overlay
        attachable: yes
        state: present
    
    - name: Create Docker Compose file
      ansible.builtin.template:
        src: templates/docker-compose.yml.j2
        dest: "{{ compose_file }}"
        owner: root
        group: root
        mode: '0644'
    
    - name: Check if stack is already deployed
      ansible.builtin.command: docker stack ls --format '{{ '{{' }}.Name{{ '}}' }}'
      register: existing_stacks
      changed_when: false

    - name: Remove existing stack if present
      ansible.builtin.command: docker stack rm {{ stack_name }}
      when: stack_name in existing_stacks.stdout_lines
      register: stack_removed

    - name: Wait for stack removal to complete
      ansible.builtin.pause:
        seconds: 15
      when: stack_removed.changed | default(false)
    
    - name: Deploy Docker stack
      community.docker.docker_stack:
        name: "{{ stack_name }}"
        compose:
          - "{{ compose_file }}"
        state: present
        prune: yes
    
    - name: Wait for services to be ready
      ansible.builtin.pause:
        seconds: 30
    
    - name: Verify service deployment
      ansible.builtin.command: |
        set -e
        docker service inspect {{ stack_name }}_turbogate --format '{{ '{{' }}.ID{{ '}}' }}'
        docker service inspect {{ stack_name }}_redis --format '{{ '{{' }}.ID{{ '}}' }}'
        docker service inspect {{ stack_name }}_nginx --format '{{ '{{' }}.ID{{ '}}' }}'
      register: service_deployment
      retries: 3
      delay: 10
      until: service_deployment.rc == 0
      changed_when: false
    
    - name: Check service status
      ansible.builtin.command: |
        docker service ls --format "table {{ '{{' }}.Name{{ '}}' }}\t{{ '{{' }}.Replicas{{ '}}' }}\t{{ '{{' }}.Mode{{ '}}' }}"
        echo "=== Detailed Status ==="
        docker service ps {{ stack_name }}_turbogate --no-trunc
        docker service ps {{ stack_name }}_redis --no-trunc
        docker service ps {{ stack_name }}_nginx --no-trunc
      register: service_status
      changed_when: false
    
    - name: Display service status
      ansible.builtin.debug:
        var: service_status.stdout_lines
    
    - name: Verify all services are running
      ansible.builtin.command: |
        docker service ps {{ stack_name }}_{{ item }} \
          --format '{{ '{{' }}.Name{{ '}}' }}: {{ '{{' }}.CurrentState{{ '}}' }}' \
          --filter 'desired-state=running'
      loop:
        - turbogate
        - redis
        - nginx
      register: service_health
      changed_when: false
      failed_when: false
    
    - name: Display service health
      ansible.builtin.debug:
        msg: "{{ item.item }}: {{ item.stdout }}"
      loop: "{{ service_health.results }}"
      when: item.stdout is defined
    
    - name: Verify service health endpoints
      ansible.builtin.command: |
        curl -sSf http://localhost/health || exit 1
        docker exec $(docker ps -q -f name={{ stack_name }}_turbogate) \
          curl -sSf http://localhost:5000/gateway/health || exit 1
        docker exec $(docker ps -q -f name={{ stack_name }}_redis) \
          redis-cli --no-auth-warning -a $(cat /run/secrets/redis_password) ping || exit 1
      register: health_check
      retries: 5
      delay: 10
      until: health_check.rc == 0
      changed_when: false