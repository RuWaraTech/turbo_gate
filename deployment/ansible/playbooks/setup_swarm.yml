---
- name: Setup Docker Swarm Cluster on Hetzner Cloud
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    # The floating IP is passed as extra var
    swarm_advertise_addr: "{{ floating_ip | default(ansible_default_ipv4.address) }}"
    
  tasks:
    - name: Install Docker using official script
      shell: |
        curl -fsSL https://get.docker.com -o get-docker.sh
        sh get-docker.sh
        rm get-docker.sh
      args:
        creates: /usr/bin/docker

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes
        daemon_reload: yes

    - name: Install Docker Python SDK
      pip:
        name:
          - docker
          - docker-compose
          - jsondiff
        state: present

    - name: Add ansible user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes
      when: ansible_user is defined and ansible_user != 'root'

    # Manager-specific tasks
    # --- START OF NEW/MODIFIED SECTION FOR MANAGER ---
    - name: Ensure Docker daemon advertises and listens on internal IP for Swarm
      ansible.builtin.copy:
        content: |
          {
            "cluster-advertise": "{{ internal_ip }}:2377",
            "cluster-listen": "{{ internal_ip }}:2377"
          }
        dest: /etc/docker/daemon.json
        owner: root
        group: root
        mode: '0644'
      when: "'manager' in group_names"
      notify: Restart docker service # Trigger handler if daemon.json changes

    - name: Ensure Docker is not in a swarm before re-initialization
      community.docker.docker_swarm:
        state: absent # Use 'absent' to leave the swarm
        force: yes    # Force leave if it's the only manager (for re-initialization)
      when: "'manager' in group_names"
      ignore_errors: yes # Ignore errors if not in a swarm or other issues
    # --- END OF NEW/MODIFIED SECTION FOR MANAGER ---

    - name: Initialize Docker Swarm on manager
      community.docker.docker_swarm: # Changed from 'docker_swarm' to 'community.docker.docker_swarm' for explicit FQCN
        state: present
        advertise_addr: "{{ internal_ip }}"
        listen_addr: "{{ internal_ip }}:2377"
      when: "'manager' in group_names"
      register: swarm_manager_info

    - name: Store join tokens
      set_fact:
        docker_worker_token: "{{ swarm_manager_info.swarm_facts.JoinTokens.Worker }}"
        docker_manager_token: "{{ swarm_manager_info.swarm_facts.JoinTokens.Manager }}"
      when: 
        - "'manager' in group_names"
        - swarm_manager_info.swarm_facts is defined

    # Worker-specific tasks
    - name: Wait for manager to be ready
      wait_for:
        host: "{{ hostvars[groups['manager'][0]]['internal_ip'] }}"
        port: 2377
        delay: 5
        timeout: 60
      when: "'workers' in group_names"

    - name: Join workers to swarm
      community.docker.docker_swarm: # Changed from 'docker_swarm' to 'community.docker.docker_swarm' for explicit FQCN
        state: join
        advertise_addr: "{{ internal_ip }}"
        join_token: "{{ hostvars[groups['manager'][0]]['docker_worker_token'] }}"
        remote_addrs:
          - "{{ hostvars[groups['manager'][0]]['internal_ip'] }}:2377"
      when: 
        - "'workers' in group_names"
        - hostvars[groups['manager'][0]]['docker_worker_token'] is defined
      retries: 3
      delay: 10

    # Verification tasks
    - name: Get docker swarm info
      community.docker.docker_swarm_info: # Changed from 'docker_swarm_info' to 'community.docker.docker_swarm_info' for explicit FQCN
      register: swarm_info
      changed_when: false

    - name: Display swarm status
      debug:
        msg:
          - "Node ID: {{ swarm_info.docker_node_id | default('Not in swarm') }}"
          - "Swarm State: {{ swarm_info.docker_swarm_active }}"
          - "Node Address: {{ swarm_info.docker_node_addr | default('N/A') }}"

    # Only on manager: set up initial swarm services
    - name: Create overlay network for applications
      community.docker.docker_network: # Changed from 'docker_network' to 'community.docker.docker_network' for explicit FQCN
        name: turbogate_network
        driver: overlay
        driver_options:
          encrypted: "true"
      when: "'manager' in group_names"

    - name: Display connection information
      debug:
        msg:
          - "Swarm initialized successfully!"
          - "Manager internal IP: {{ hostvars[groups['manager'][0]]['internal_ip'] }}"
          - "Manager public IP: {{ hostvars[groups['manager'][0]]['ansible_default_ipv4']['address'] }}"
          - "Floating IP: {{ floating_ip }}"
          - "Worker token: {{ docker_worker_token | default('N/A') }}"
      when: "'manager' in group_names"
      run_once: true

  # --- START OF NEW HANDLERS SECTION ---
  handlers:
    - name: Restart docker service
      ansible.builtin.systemd:
        name: docker
        state: restarted
        daemon_reload: yes
  # --- END OF NEW HANDLERS SECTION ---