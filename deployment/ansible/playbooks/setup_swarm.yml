---
- name: Setup Docker Swarm Cluster on Hetzner Cloud
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    # The floating IP is passed as extra var
    swarm_advertise_addr: "{{ floating_ip | default(ansible_default_ipv4.address) }}"
    
  tasks:
    - name: Install Docker using official script
      shell: |
        curl -fsSL https://get.docker.com -o get-docker.sh
        sh get-docker.sh
        rm get-docker.sh
      args:
        creates: /usr/bin/docker

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes
        daemon_reload: yes

    - name: Install Docker Python SDK
      pip:
        name:
          - docker
          - docker-compose
          - jsondiff
        state: present

    - name: Add ansible user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes
      when: ansible_user is defined and ansible_user != 'root'

    # Manager-specific tasks
    - name: Initialize Docker Swarm on manager
      docker_swarm:
        state: present
        advertise_addr: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}"
        listen_addr: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}:2377"
      when: "'manager' in group_names"
      register: swarm_manager_info

    - name: Store join tokens
      set_fact:
        docker_worker_token: "{{ swarm_manager_info.swarm_facts.JoinTokens.Worker }}"
        docker_manager_token: "{{ swarm_manager_info.swarm_facts.JoinTokens.Manager }}"
      when: 
        - "'manager' in group_names"
        - swarm_manager_info.swarm_facts is defined

    # Worker-specific tasks
    - name: Wait for manager to be ready
      wait_for:
        host: "{{ hostvars[groups['manager'][0]]['ansible_default_ipv4']['address'] }}"
        port: 2377
        delay: 5
        timeout: 60
      when: "'workers' in group_names"

    - name: Join workers to swarm
      docker_swarm:
        state: join
        advertise_addr: "{{ ansible_default_ipv4.address }}"
        join_token: "{{ hostvars[groups['manager'][0]]['docker_worker_token'] }}"
        remote_addrs:
          - "{{ hostvars[groups['manager'][0]]['ansible_default_ipv4']['address'] }}:2377"
      when: 
        - "'workers' in group_names"
        - hostvars[groups['manager'][0]]['docker_worker_token'] is defined
      retries: 3
      delay: 10

    # Verification tasks
    - name: Get docker swarm info
      docker_swarm_info:
      register: swarm_info
      changed_when: false

    - name: Display swarm status
      debug:
        msg:
          - "Node ID: {{ swarm_info.docker_node_id | default('Not in swarm') }}"
          - "Swarm State: {{ swarm_info.docker_swarm_active }}"
          - "Node Address: {{ swarm_info.docker_node_addr | default('N/A') }}"

    # Only on manager: set up initial swarm services
    - name: Create overlay network for applications
      docker_network:
        name: turbogate_network
        driver: overlay
        driver_options:
          encrypted: "true"
      when: "'manager' in group_names"

    - name: Display connection information
      debug:
        msg:
          - "Swarm initialized successfully!"
          - "Manager internal IP: {{ hostvars[groups['manager'][0]]['ansible_default_ipv4']['address'] }}"
          - "Floating IP: {{ floating_ip }}"
          - "Worker token: {{ docker_worker_token | default('N/A') }}"
      when: "'manager' in group_names"
      run_once: true