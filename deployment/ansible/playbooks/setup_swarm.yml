---
- name: Setup Docker Swarm Cluster
  hosts: all
  become: yes
  
  tasks:
    - name: Install Docker
      include_role:
        name: docker
    
    - name: Initialize Swarm on manager
      docker_swarm:
        state: present
      when: swarm_role == "manager"
      register: swarm_info
    
    - name: Get join token for workers
      set_fact:
        worker_token: "{{ swarm_info.swarm_facts.JoinTokens.Worker }}"
      when: swarm_role == "manager"
    
    - name: Join workers to swarm
      docker_swarm:
        state: join
        join_token: "{{ hostvars[groups['swarm_managers'][0]]['worker_token'] }}"
        remote_addrs: ["{{ hostvars[groups['swarm_managers'][0]]['ansible_default_ipv4']['address'] }}:2377"]
      when: swarm_role == "worker"